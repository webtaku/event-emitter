{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["type EventMap = Record<string, (...args: any[]) => any>\ntype WithRemove<E extends EventMap> = E & { remove: () => void }\n\nabstract class EventEmitter<E extends EventMap> {\n  #listeners: { [K in keyof WithRemove<E>]?: { listener: WithRemove<E>[K]; once?: boolean }[] } = {}\n\n  on<K extends keyof WithRemove<E>>(key: K, listener: WithRemove<E>[K]): this {\n    if (!this.#listeners[key]) this.#listeners[key] = []\n    this.#listeners[key].push({ listener })\n    return this\n  }\n\n  once<K extends keyof WithRemove<E>>(key: K, listener: WithRemove<E>[K]): this {\n    if (!this.#listeners[key]) this.#listeners[key] = []\n    this.#listeners[key].push({ listener, once: true })\n    return this\n  }\n\n  off<K extends keyof WithRemove<E>>(key: K, listener: WithRemove<E>[K]): this {\n    const events = this.#listeners[key]\n    if (!events) return this\n    this.#listeners[key] = events.filter((e) => e.listener !== listener)\n    if (this.#listeners[key].length === 0) delete this.#listeners[key]\n    return this\n  }\n\n  async emit<K extends keyof WithRemove<E>>(key: K, ...args: Parameters<WithRemove<E>[K]>): Promise<ReturnType<WithRemove<E>[K]>[]> {\n    const events = this.#listeners[key]\n    if (!events) return []\n\n    const results: ReturnType<WithRemove<E>[K]>[] = []\n    const promises: Promise<ReturnType<WithRemove<E>[K]>>[] = []\n\n    for (const event of events) {\n      const result = event.listener(...args)\n      if (event.once) this.off(key, event.listener)\n      if (result instanceof Promise) promises.push(result)\n      else results.push(result)\n    }\n\n    return results.concat(await Promise.all(promises))\n  }\n\n  #bindings: Array<{\n    key: string\n    target: EventEmitter<EventMap>\n    listener: (...args: any[]) => any\n    removeHandler: () => void\n  }> = []\n\n  bindTo<K extends keyof WithRemove<E>>(target: EventEmitter<EventMap>, key: K, listener: WithRemove<E>[K]): this {\n    this.on(key, listener)\n\n    const removeHandler = () => {\n      this.off(key, listener)\n      const findIndex = this.#bindings.findIndex(\n        (b) =>\n          b.target === target &&\n          b.key === key &&\n          b.listener === listener\n      )\n      if (findIndex !== -1) this.#bindings.splice(findIndex, 1)\n    }\n\n    target.on('remove', removeHandler)\n\n    this.#bindings.push({\n      key: key as string,\n      target,\n      listener,\n      removeHandler\n    })\n\n    return this\n  }\n\n  remove() {\n    (this as any).emit('remove')\n    for (const b of this.#bindings) {\n      b.target.off('remove', b.removeHandler)\n    }\n    this.#bindings.length = 0\n  }\n}\n\nexport { EventEmitter, EventMap }\n"]}